variables:
  - name: VERSION
    default: "v1.34.0"
  - name: IMAGE_NAME
    default: "docker.io/kindest/node"
  - name: NGINX_EXTRA_PORTS
    default: "[]"

tasks:
  - name: default
    description: "Runs a full build, deploy, and test of the package"
    actions:
      - task: build-kernel
      - task: build
      - task: deploy
      - task: validate

  - name: build-kernel
    description: "Build the custom Linux kernel if it does not exist"
    actions:
      - description: "Check for existing kernel build"
        cmd: |
          if [ -d containerization/kernel ]; then
            echo "Kernel build found. Skipping build..."
          else
            echo "Kernel build not found! Building..."
            make -C containerization/kernel
          fi

  - name: build
    description: "Build uds-apple-containerization"
    actions:
      - description: "Build UDS Apple Containerization package"
        cmd: "uds zarf package create -a arm64 --confirm --skip-sbom"

  - name: deploy
    description: "Deploy uds-apple-containerization package"
    actions:
      - description: "Deploy UDS Apple Containerization package"
        cmd: |
          uds zarf package deploy zarf-package-uds-apple-containerization-arm64-*.tar.zst \
            --set NODE_IMAGE=${IMAGE_NAME}:${VERSION} \
            --set NGINX_EXTRA_PORTS="${NGINX_EXTRA_PORTS}" \
            --confirm

  - name: validate
    actions:
      - task: validate-coredns
      - cmd: uds zarf tools download-init
        description: "Download the zarf init package"
      - task: validate-zarf-init

  - name: validate-coredns
    actions:
      - description: Validate coredns is up
        wait:
          cluster:
            kind: Pod
            name: "k8s-app=kube-dns"
            namespace: kube-system
            condition: Ready
      - description: Validate coredns is resolving *.uds.dev internally
        cmd: |
          set -e
          # renovate: datasource=docker depName=quay.io/nginx/nginx-unprivileged versioning=docker
          FOO_IP=$(kubectl run test --image=quay.io/nginx/nginx-unprivileged:1.29.3-alpine -q --restart=Never --rm -i -- sh -c "getent hosts foo.uds.dev | awk '{print \$1}'")
          if [ "${FOO_IP}" != "127.0.0.1" ]; then
            echo "CoreDNS is resolving foo.uds.dev to the gateway service"
          else
            echo "CoreDNS patch failed, foo.uds.dev is resolving to 127.0.0.1"
            exit 1
          fi

  - name: validate-zarf-init
    actions:
      - description: Validate zarf init
        cmd: uds zarf init --confirm
