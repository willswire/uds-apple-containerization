# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json

kind: ZarfPackageConfig
metadata:
  name: uds-apple-containerization
  description: "UDS Cluster Setup using the cluster CLI. WARNING: This will destroy the cluster if it already exists."
  url: https://github.com/willswire/uds-apple-containerization
  yolo: true
  # x-release-please-start-version
  version: "0.19.4"
  # x-release-please-end

variables:
  - name: NGINX_EXTRA_PORTS
    description: "Optionally allow more ports through Nginx"
    default: "[]"

  - name: DOMAIN
    description: "Cluster domain"
    default: "uds.dev"

  - name: ADMIN_DOMAIN
    description: "Domain for admin services, defaults to `admin.DOMAIN`"

components:
  - name: uds-dev-stack
    required: true
    description: "Install MetalLB, NGINX, Minio, local-path-rwx and Ensure MachineID to meet UDS developer needs without later config changes"
    actions:
      onDeploy:
        before:
          - cmd: ./zarf tools kubectl get nodes -o=jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' | cut -d'.' -f1-3
            description: "Load network ip base for MetalLB"
            setVariables:
              - name: BASE_IP
        after:
          - cmd: |
              ./zarf tools kubectl -n kube-system patch configmap coredns --type merge --patch-file manifests/coredns-corefile-import-patch.yaml
            description: "Patch CoreDNS Corefile to import custom overrides"
          - cmd: |
              ./zarf tools kubectl -n kube-system patch deployment coredns --type strategic --patch-file manifests/coredns-deployment-patch.yaml
            description: "Mount coredns-custom configmap into CoreDNS pods"
          - cmd: ./zarf tools kubectl rollout status deployment coredns -n kube-system --timeout=60s
            description: "Wait for CoreDNS rollout to complete"
    charts:
      - name: metallb
        namespace: kube-system
        url: https://metallb.github.io/metallb
        version: 0.15.3
        valuesFiles:
          - "values/metallb-values.yaml"
      - name: uds-dev-stack
        namespace: kube-system
        localPath: chart
        # x-release-please-start-version
        version: 0.19.4
        # x-release-please-end
        valuesFiles:
          - "values/dev-stack-values.yaml"
        variables:
          - name: COREDNS_OVERRIDES
            # Defaults contain rewrites of `*.uds.dev` to the UDS core Istio tenant and admin gateways
            description: "CoreDNS overrides"
            path: coreDnsOverrides
      - name: minio
        namespace: uds-dev-stack
        version: 5.4.0
        url: https://charts.min.io/
        valuesFiles:
          - "values/minio-values.yaml"
